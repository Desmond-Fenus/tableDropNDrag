// Первый класс для создания template для последующего заполнения таблицы
// * Можешь посмотреть пример рендериющийса таблицы из памяти использовав метод renderExample(ControlTable.exampleRenderedData);

class ControlTable {
  static attribute = "cell-id-data";
  static exampleRenderedData = [
    [
      {
        rowId: 0,
        colId: 0,
        cellId: "0_0_controlTable",
        free: false,
        main: true,
        display: "table-cell",
        componentName: "1",
        componentSize: [2, 2],
      },
      {
        rowId: 0,
        colId: 1,
        cellId: "0_1_controlTable",
        free: false,
        main: false,
        display: "none",
        componentName: "1",
        componentSize: [1, 1],
      },
      {
        rowId: 0,
        colId: 2,
        cellId: "0_2_controlTable",
        free: false,
        main: true,
        display: "table-cell",
        componentName: "1",
        componentSize: [2, 2],
      },
      {
        rowId: 0,
        colId: 3,
        cellId: "0_3_controlTable",
        free: false,
        main: false,
        display: "none",
        componentName: "1",
        componentSize: [1, 1],
      },
      {
        rowId: 0,
        colId: 4,
        cellId: "0_4_controlTable",
        free: false,
        main: true,
        display: "table-cell",
        componentName: "1",
        componentSize: [2, 2],
      },
      {
        rowId: 0,
        colId: 5,
        cellId: "0_5_controlTable",
        free: false,
        main: false,
        display: "none",
        componentName: "1",
        componentSize: [1, 1],
      },
      {
        rowId: 0,
        colId: 6,
        cellId: "0_6_controlTable",
        free: false,
        main: true,
        display: "table-cell",
        componentName: "w",
        componentSize: [3, 1],
      },
    ],
    [
      {
        rowId: 1,
        colId: 0,
        cellId: "1_0_controlTable",
        free: false,
        main: false,
        display: "none",
        componentName: "1",
        componentSize: [1, 1],
      },
      {
        rowId: 1,
        colId: 1,
        cellId: "1_1_controlTable",
        free: false,
        main: false,
        display: "none",
        componentName: "1",
        componentSize: [1, 1],
      },
      {
        rowId: 1,
        colId: 2,
        cellId: "1_2_controlTable",
        free: false,
        main: false,
        display: "none",
        componentName: "1",
        componentSize: [1, 1],
      },
      {
        rowId: 1,
        colId: 3,
        cellId: "1_3_controlTable",
        free: false,
        main: false,
        display: "none",
        componentName: "1",
        componentSize: [1, 1],
      },
      {
        rowId: 1,
        colId: 4,
        cellId: "1_4_controlTable",
        free: false,
        main: false,
        display: "none",
        componentName: "1",
        componentSize: [1, 1],
      },
      {
        rowId: 1,
        colId: 5,
        cellId: "1_5_controlTable",
        free: false,
        main: false,
        display: "none",
        componentName: "1",
        componentSize: [1, 1],
      },
      {
        rowId: 1,
        colId: 6,
        cellId: "1_6_controlTable",
        free: false,
        main: false,
        display: "none",
        componentName: "w",
        componentSize: [1, 1],
      },
    ],
    [
      {
        rowId: 2,
        colId: 0,
        cellId: "2_0_controlTable",
        free: false,
        main: true,
        display: "table-cell",
        componentName: "q",
        componentSize: [2, 4],
      },
      {
        rowId: 2,
        colId: 1,
        cellId: "2_1_controlTable",
        free: false,
        main: false,
        display: "none",
        componentName: "q",
        componentSize: [1, 1],
      },
      {
        rowId: 2,
        colId: 2,
        cellId: "2_2_controlTable",
        free: false,
        main: false,
        display: "none",
        componentName: "q",
        componentSize: [1, 1],
      },
      {
        rowId: 2,
        colId: 3,
        cellId: "2_3_controlTable",
        free: false,
        main: false,
        display: "none",
        componentName: "q",
        componentSize: [1, 1],
      },
      {
        rowId: 2,
        colId: 4,
        cellId: "2_4_controlTable",
        free: false,
        main: true,
        display: "table-cell",
        componentName: "1",
        componentSize: [2, 2],
      },
      {
        rowId: 2,
        colId: 5,
        cellId: "2_5_controlTable",
        free: false,
        main: false,
        display: "none",
        componentName: "1",
        componentSize: [1, 1],
      },
      {
        rowId: 2,
        colId: 6,
        cellId: "2_6_controlTable",
        free: false,
        main: false,
        display: "none",
        componentName: "w",
        componentSize: [1, 1],
      },
    ],
    [
      {
        rowId: 3,
        colId: 0,
        cellId: "3_0_controlTable",
        free: false,
        main: false,
        display: "none",
        componentName: "q",
        componentSize: [1, 1],
      },
      {
        rowId: 3,
        colId: 1,
        cellId: "3_1_controlTable",
        free: false,
        main: false,
        display: "none",
        componentName: "q",
        componentSize: [1, 1],
      },
      {
        rowId: 3,
        colId: 2,
        cellId: "3_2_controlTable",
        free: false,
        main: false,
        display: "none",
        componentName: "q",
        componentSize: [1, 1],
      },
      {
        rowId: 3,
        colId: 3,
        cellId: "3_3_controlTable",
        free: false,
        main: false,
        display: "none",
        componentName: "q",
        componentSize: [1, 1],
      },
      {
        rowId: 3,
        colId: 4,
        cellId: "3_4_controlTable",
        free: false,
        main: false,
        display: "none",
        componentName: "1",
        componentSize: [1, 1],
      },
      {
        rowId: 3,
        colId: 5,
        cellId: "3_5_controlTable",
        free: false,
        main: false,
        display: "none",
        componentName: "1",
        componentSize: [1, 1],
      },
      {
        rowId: 3,
        colId: 6,
        cellId: "3_6_controlTable",
        free: true,
        main: false,
        display: "table-cell",
        componentName: "",
        componentSize: [1, 1],
      },
    ],
    [
      {
        rowId: 4,
        colId: 0,
        cellId: "4_0_controlTable",
        free: false,
        main: true,
        display: "table-cell",
        componentName: "t",
        componentSize: [1, 4],
      },
      {
        rowId: 4,
        colId: 1,
        cellId: "4_1_controlTable",
        free: false,
        main: false,
        display: "none",
        componentName: "t",
        componentSize: [1, 1],
      },
      {
        rowId: 4,
        colId: 2,
        cellId: "4_2_controlTable",
        free: false,
        main: false,
        display: "none",
        componentName: "t",
        componentSize: [1, 1],
      },
      {
        rowId: 4,
        colId: 3,
        cellId: "4_3_controlTable",
        free: false,
        main: false,
        display: "none",
        componentName: "t",
        componentSize: [1, 1],
      },
      {
        rowId: 4,
        colId: 4,
        cellId: "4_4_controlTable",
        free: true,
        main: false,
        display: "table-cell",
        componentName: "",
        componentSize: [1, 1],
      },
      {
        rowId: 4,
        colId: 5,
        cellId: "4_5_controlTable",
        free: true,
        main: false,
        display: "table-cell",
        componentName: "",
        componentSize: [1, 1],
      },
      {
        rowId: 4,
        colId: 6,
        cellId: "4_6_controlTable",
        free: true,
        main: false,
        display: "table-cell",
        componentName: "",
        componentSize: [1, 1],
      },
    ],
  ];

  constructor(
    amountOfRows = 2,
    amountOfColumn = 2,
    tablePlace = "controlTable"
  ) {
    this.tablePlace = document.getElementById(tablePlace);
    this.tableName = tablePlace;
    this.amountOfRows = amountOfRows;
    this.amountOfColumn = amountOfColumn;
    this.renderedTableData = [];
    this.historyUpdates = [];
  }

  // инкапсулированный класс для создания состояния клетки (будет раширяться для подгрузок и проверок)

  #Cell = class {
    constructor(rowId, colId, tableName) {
      this.rowId = rowId;
      this.colId = colId;
      this.cellId = `${this.rowId}_${this.colId}_${tableName}`;

      this.free = true;
      this.main = false;
      this.display = "table-cell";
      this.componentName = "";
      this.componentSize = [1, 1];
    }
  };

  ControlPanel = class {
    constructor(controlPanelPlace = `controlPanelOf${this.tableName}`) {
      this.controlPanelPlace = document.getElementById("controlPanelPlace");
      this.controlPanelName = controlPanelPlace;
    }
  };

  // функция, которая создает экземпляр данных клетки

  #addNewCell(elemRowNumber, elemColNumber, tableName) {
    return new this.#Cell(elemRowNumber, elemColNumber, tableName);
  }

  // Вызывается для создания экземпляра таблицы для последущего рендера

  #fillRenderedTableData() {
    for (let i = 0; i < this.amountOfRows; i++) {
      let row = [];
      for (let j = 0; j < this.amountOfColumn; j++) {
        row.push(this.#addNewCell(i, j, this.tableName));
      }
      this.renderedTableData.push(row);
    }
  }

  #renderTable() {
    console.log("rendered");
    let table = document.createElement("table");
    table.classList.add(`${this.tableName}_table`);

    for (const row of this.renderedTableData) {
      let tr = document.createElement("tr");
      tr.style.height = `${100 / this.renderedTableData.length}%`;

      for (const elem of row) {
        let td = document.createElement("td");

        Object.assign(td.style, {
          display: elem.display,
          width: `${(elem.componentSize[1] / row.length) * 100}%`,
        });

        td.setAttribute("rowspan", elem.componentSize[0]);
        td.setAttribute("colspan", elem.componentSize[1]);
        td.classList.add(`${this.tableName}_cell`);
        td.innerText = "+";
        td.setAttribute(ControlTable.attribute, elem.cellId);
        tr.appendChild(td);
      }

      table.appendChild(tr);
    }

    this.tablePlace.appendChild(table);

    // добавляется событие после рендера таблицы

    table.addEventListener("dragover", (event) => {
      event.preventDefault();
    });
    table.addEventListener("drop", (event) => {
      event.preventDefault();

      // в ComponentData должно содержаться размер с названием size, название компонента compName
      const componentData = JSON.parse(event.dataTransfer.getData("text"));

      // в targetPosition мы определяем массив с координатами реальной клетки на таблице на которую мы бросили компонент с componentData
      const targetPosition = event.target
        .getAttribute(ControlTable.attribute)
        .split("_")
        .map(Number);

      console.log(componentData);

      if (
        this.#isPlacementPossible(targetPosition, componentData.componentSize)
      ) {
        this.#mergeCells(event.target, targetPosition, componentData);
      } else {
        alert("Placement is not possible");
      }

      console.log(this.renderedTableData);
    });
  }

  // ! пример рендера с готовой датой
  renderExample(exampleData) {
    let table = document.createElement("table");
    table.classList.add(`${this.tableName}_table`);

    exampleData.forEach((row) => {
      let tr = document.createElement("tr");
      tr.style.height = `${100 / exampleData.length}%`;

      row.forEach((elem) => {
        let td = document.createElement("td");
        td.setAttribute("rowspan", elem.componentSize[0]);
        td.setAttribute("colspan", elem.componentSize[1]);

        td.style.display = elem.display;

        td.classList.add(`${this.tableName}_cell`);
        td.style.width = `${(elem.componentSize[1] / row.length) * 100}%`;
        td.innerText = "+";
        td.setAttribute(ControlTable.attribute, elem.cellId);
        tr.appendChild(td);
      });

      table.appendChild(tr);
    });

    this.tablePlace.appendChild(table);
  }
  // ! _________________________________

  #mergeCells(targetCell, startCoordinate, componentData) {
    const [startRow, startCol] = startCoordinate;
    const [rowSpan, colSpan] = componentData.componentSize;

    let arrForSave = [];
    arrForSave.push(
      [startRow, startCol],
      [startRow + rowSpan, startCol + colSpan]
    );

    targetCell.setAttribute("rowspan", rowSpan);
    targetCell.setAttribute("colspan", colSpan);
    targetCell.setAttribute("main", "true");

    const endRow = startRow + rowSpan;
    const endCol = startCol + colSpan;
    const widthPercent = (colSpan / this.renderedTableData[0].length) * 100;

    for (let i = startRow; i < endRow; i++) {
      for (let j = startCol; j < endCol; j++) {
        let chekingElement = document.querySelector(
          `td[${ControlTable.attribute}="${this.renderedTableData[i][j].cellId}"]`
        );

        if (chekingElement.hasAttribute("main")) {
          Object.assign(chekingElement.style, {
            width: `${widthPercent}%`,
          });
          Object.assign(this.renderedTableData[i][j], {
            main: true,
            componentSize: componentData.componentSize,
            componentName: componentData.componentName,
            free: false,
          });
        } else {
          Object.assign(chekingElement.style, {
            display: "none",
          });
          Object.assign(this.renderedTableData[i][j], {
            display: "none",
            free: false,
            componentName: componentData.componentName,
          });
        }
      }
    }
    this.historyUpdates.push(arrForSave);
  }

  #isPlacementPossible(startCoordinate, componentSize) {
    if (
      startCoordinate[0] + componentSize[0] > this.renderedTableData.length ||
      startCoordinate[1] + componentSize[1] > this.renderedTableData[0].length
    ) {
      console.log("not enough space");
      return false;
    }

    for (
      let i = startCoordinate[0];
      i < startCoordinate[0] + componentSize[0];
      i++
    ) {
      for (
        let j = startCoordinate[1];
        j < startCoordinate[1] + componentSize[1];
        j++
      ) {
        if (this.renderedTableData[i][j].free === false) {
          console.log("not free");
          return false;
        }
      }
    }
    return true;
  }

  createNewTable() {
    this.#fillRenderedTableData();
    this.#renderTable();
  }

  cancelMerge() {
    const lastSave = this.historyUpdates.pop();
    const [startCell, endCell] = lastSave;
    console.log(startCell, endCell);
    for (let i = startCell[0]; i < endCell[0]; i++) {
      for (let j = startCell[1]; j < endCell[1]; j++) {
        let chekingElement = document.querySelector(
          `td[${ControlTable.attribute}="${this.renderedTableData[i][j].cellId}"]`
        );
        chekingElement.setAttribute("rowspan", "1");
        chekingElement.setAttribute("colspan", "1");
        chekingElement.removeAttribute("main");
        chekingElement.style.display = "table-cell";
        chekingElement.style.width = `${
          (1 / this.renderedTableData[0].length) * 100
        }%`;

        Object.assign(this.renderedTableData[i][j], {
          free: true,
          main: false,
          display: "table-cell",
          componentName: "",
          componentSize: [1, 1],
        });
      }
    }
    console.log(this.renderedTableData);
  }
}

// TODO сделать список элементы которого можно будет перетаскивать на таблицу для их отображения в них
// TODO добавить к ним размер компонента и название к которому можно будет привязать компонент вью

class DraggableList {
  constructor(listName, listPlace = "draggableList") {
    this.listName = listName;
    this.listPlace = document.getElementById(listPlace);
    this.catalogOfItems = [];
  }

  #ListItem = class {
    constructor(itemName, height, width) {
      this.itemName = itemName;
      this.height = height;
      this.width = width;
    }
  };

  addNewItem(itemName, height, width) {
    this.catalogOfItems.push(new this.#ListItem(itemName, height, width));

    let listItem = document.createElement("div");
    listItem.draggable = true;
    listItem.addEventListener("dragstart", (event) => {
      event.dataTransfer.setData(
        "text",
        JSON.stringify({
          componentSize: [height, width],
          componentName: itemName,
        })
      );
    });
    listItem.innerText = `${itemName}, ${height}, ${width}`;
    listItem.classList.add("itemStyle");

    this.listPlace.appendChild(listItem);
  }

  addNewItems(arr) {
    arr.forEach((elem) => {
      this.addNewItem(...elem);
    });
  }
}

const controlTable = new ControlTable(5, 7);
// controlTable.renderExample(ControlTable.exampleRenderedData);
controlTable.createNewTable();

const newList = new DraggableList("first list");
newList.addNewItem("1", 2, 2);

const arr = [
  ["q", 2, 4],
  ["w", 3, 1],
  ["t", 1, 4],
];
newList.addNewItems(arr);

document.getElementById("cancelMerge").addEventListener("click", () => {
  controlTable.cancelMerge();
});
